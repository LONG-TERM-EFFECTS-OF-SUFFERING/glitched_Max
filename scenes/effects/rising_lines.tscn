[gd_scene load_steps=8 format=3 uid="uid://44adfkoyahkk"]

[ext_resource type="Script" uid="uid://b2k1yutn1j56e" path="res://scenes/effects/particles.gd" id="1_s1ym4"]

[sub_resource type="Shader" id="Shader_s1ym4"]
code = "
shader_type spatial;
render_mode unshaded, cull_disabled, blend_add;

uniform sampler2D color_ramp;
uniform vec3 emission_color : source_color = vec3(0.0, 1.0, 1.0);
uniform float emission_energy = 2.5;

float get_scale_y(float life_percent) {
    if (life_percent < 0.2) {
        return smoothstep(0.0, 0.2, life_percent);
    } else if (life_percent < 0.8) {
        return 1.0;
    } else {
        return smoothstep(1.0, 0.8, life_percent);
    }
}

void vertex() {
    vec3 cam_pos = INV_VIEW_MATRIX[3].xyz;
    vec3 particle_pos = (MODEL_MATRIX * vec4(0.0, 0.0, 0.0, 1.0)).xyz;
    vec3 to_camera = normalize(cam_pos - particle_pos);
    
    to_camera.y = 0.0;
    to_camera = normalize(to_camera);
    
    vec3 up = vec3(0.0, 1.0, 0.0);
    vec3 right = normalize(cross(up, to_camera));
    
    float life = COLOR.a;
    float scale_y = get_scale_y(1.0 - INSTANCE_CUSTOM.y);
    
    vec3 local_pos = VERTEX;
    local_pos.y *= scale_y;
    VERTEX = right * local_pos.x + up * local_pos.y;
    
    UV = UV;
}

void fragment() {
    vec4 base_color = vec4(emission_color, 1.0);
    ALBEDO = base_color.rgb * COLOR.rgb;
    ALPHA = COLOR.a;
    EMISSION = emission_color * emission_energy;
}
"

[sub_resource type="ShaderMaterial" id="ShaderMaterial_ipsn0"]
render_priority = 0
shader = SubResource("Shader_s1ym4")
shader_parameter/emission_color = Color(0, 1, 1, 1)
shader_parameter/emission_energy = 2.5

[sub_resource type="Gradient" id="Gradient_dby3b"]
offsets = PackedFloat32Array(0, 0, 0.15, 0.5, 0.85, 1, 1)
colors = PackedColorArray(0, 0, 0, 1, 0, 0.8, 1, 0, 0, 0.8, 1, 0.8, 0.2, 0.95, 1, 1, 0.4, 0.9, 1, 0.132, 1, 1, 1, 1, 0.4, 0.9, 1, 0)

[sub_resource type="GradientTexture1D" id="GradientTexture1D_mq7s5"]
gradient = SubResource("Gradient_dby3b")

[sub_resource type="ParticleProcessMaterial" id="ParticleProcessMaterial_i1qfu"]
emission_shape = 6
emission_ring_axis = Vector3(0, 1, 0)
emission_ring_height = 0.0
emission_ring_radius = 10.0
emission_ring_inner_radius = 3.5
emission_ring_cone_angle = 90.0
direction = Vector3(0, 1, 0)
spread = 0.0
initial_velocity_min = 2.0
initial_velocity_max = 2.0
gravity = Vector3(0, 0, 0)
scale_min = 0.04
scale_max = 0.04
color_ramp = SubResource("GradientTexture1D_mq7s5")
hue_variation_min = -0.02
hue_variation_max = 0.02

[sub_resource type="QuadMesh" id="QuadMesh_iiwjs"]
size = Vector2(0.12, 40)

[node name="RisingLines" type="Node3D"]

[node name="Particles" type="GPUParticles3D" parent="."]
material_override = SubResource("ShaderMaterial_ipsn0")
amount = 32
lifetime = 8.0
preprocess = 0.5
visibility_aabb = AABB(-10, 0, -10, 20, 48, 20)
process_material = SubResource("ParticleProcessMaterial_i1qfu")
draw_pass_1 = SubResource("QuadMesh_iiwjs")
script = ExtResource("1_s1ym4")
particles_per_second = 10.0
